var CloudCommander=function(){"use strict";var CloudClient={init:null,KeyBinding:null,Config:null,Editor:null,Viewer:null,Terminal:null,Menu:null,GoogleAnalytics:null,_loadDir:null,Cache:{},Util:{},_ajaxLoad:null,_getJSONfromFileTable:null,_changeLinks:null,CURRENT_FILE:"current-file",LIBDIR:"/lib/",LIBDIRCLIENT:"/lib/client/",HEIGHT:0,MIN_ONE_PANEL_WIDTH:1155,OLD_BROWSER:!1},cloudcmd=CloudClient,CloudFunc,$,Util,KeyBinding,getByClass,getById;return CloudClient.Cache={_allowed:!0,isAllowed:function(){},type:{},set:function(){},get:function(){},clear:function(){}},CloudClient.Cache.isAllowed=function(){window.localStorage&&localStorage.setItem&&localStorage.getItem?CloudClient.Cache._allowed=!0:CloudClient.Cache._allowed=!1},CloudClient.Cache.set=function(e,t){CloudClient.Cache._allowed&&e&&t&&localStorage.setItem(e,t)},CloudClient.Cache.get=function(e){return CloudClient.Cache._allowed&&e?localStorage.getItem(e):null},CloudClient.Cache.clear=function(){CloudClient.Cache._allowed&&localStorage.clear()},CloudClient.Util=function(){var e;this.addClass=function(e,t){var n=e.classList;if(n)n.add(t);else{var r="";e.className&&(r=" "),e.className+=r+"hidden"}},this.ajax=function(t){if(window.XMLHttpRequest){e||(e=new XMLHttpRequest);var n="GET";t.method&&(n=t.method),e.open(n,t.url,!0),e.send(null);var r=t.success;typeof r!="function"&&console.log("error in Util.ajax onSuccess:",t),e.onreadystatechange=function(n){if(e.readyState===4){var i=n.target,s=e.getResponseHeader("content-type");if(e.status===200){var o=i.response;if(s&&s.indexOf("application/json")===0)try{o=JSON.parse(i.response)}catch(u){console.log("Error: could not parsejson from server from url: "+t.url),o=i.response}r(o,i.statusText,i)}else{var a=t.error;s&&s.indexOf("text/plain")!==0&&(i.responseText=i.statusText),typeof a=="function"&&a(i)}}}}else $.ajax(t)},this.bind=function(e,t){return e.bind(t)},this.getIdBySrc=function(e){var t=e.replace(e.substr(e,e.lastIndexOf("/")+1),"");while(t.indexOf(".")>0)t=t.replace(".","_");return t},this.loadOnload=function(e){if(e instanceof Array){var t=e.pop();return typeof t=="function"&&t(),this.loadOnload(e)}if(typeof e=="function")return e()},this.anyLoadOnload=function(e){if(e instanceof Array){var t=e.pop();return t.func||(t.func=function(){i.anyLoadOnload(e)}),this.anyload(t)}},this.anyload=function(e){if(e instanceof Array){var t=[];for(var n=0;n<e.length;n++)t[n]=this.anyload(e[n]);return t}var r=e.id,i=e.className,s=e.src,o=e.func,u=e.async;!r&&s&&(r=this.getIdBySrc(s));var a=getById(r);if(!a){if(!e.name)return{code:-1,text:"name can not be empty"};a=document.createElement(e.name),r&&(a.id=r),i&&(a.className=i),e.name==="link"?(a.href=s)&&(a.rel="stylesheet"):a.src=s,e.func&&(typeof o=="function"?a.onload=o:typeof o=="object"&&o.onload&&typeof o.onload=="function"&&(a.onload=o.onload)),a.onerror=function(){(e.parent||document.body).removeChild(a),Util.Images.showError({responseText:"file "+s+" could not be loaded",status:404}),o&&o.onerror&&typeof o.onerror=="function"&&o.onerror()},e.style&&(a.style.cssText=e.style);if(u||u===undefined)a.async=!0;e.not_append||(e.parent||document.body).appendChild(a),e.inner&&(a.innerHTML=e.inner)}else o&&(typeof o=="function"?o():typeof o=="object"&&typeof o.onload=="function"&&o.onload());return a},this.jsload=function(e,t){if(e instanceof Array){for(var n=0;n<e.length;n++)e[n].name="script";return this.anyload(e)}return this.anyload({name:"script",src:e,func:t})},this.cssSet=function(e){return e.name="style",e.parent=e.parent||document.head,this.anyload(e)},this.cssLoad=function(e){if(e instanceof Array){for(var t=0;t<e.length;t++)e[t].name="link",e[t].parent=e.parent||document.head;return this.anyload(e)}return e.name="link",e.parent=e.parent||document.head,this.anyload(e)},this.jqueryLoad=function(e){Util.jsload("//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js",{onload:function(){$=window.jQuery,typeof e=="function"&&e()},onerror:function(){Util.jsload("lib/client/jquery.js"),Util.cssSet({id:"local-droids-font",element:document.head,inner:'@font-face {font-family: "Droid Sans Mono";font-style: normal;font-weight: normal;src: local("Droid Sans Mono"), local("DroidSansMono"), url("font/DroidSansMono.woff") format("woff");}'})}})},this.getByTag=function(e,t){return(t||document).getElementsByTagName(e)},this.getById=function(e,t){return(t||document).getElementById(e)},this.getByClass=function(e,t){return(t||document).getElementsByClassName(e)};var t,n,r={loading:function(){var e=Util.getById("loading-image");return e||(e=Util.anyload({name:"span",className:"icon loading",id:"loading-image",not_append:!0})),t=e,e},error:function(){var e=Util.getById("error-image");return e||(e=Util.anyload({name:"span",className:"icon error",id:"error-image",not_append:!0})),e}},i=this;this.Images={showLoad:function(e){var s=!0;t=r.loading(),n=r.error(),Util.hide(n);var o;e?e.top&&(o=i.getRefreshButton(),o?o=o.parentElement:s=!1):(o=i.getCurrentFile(),o=o.firstChild.nextSibling);if(s){var u=t.parentElement;(!u||u&&u!==o)&&o.appendChild(t),Util.show(t)}return s},hideLoad:function(){t=r.loading(),Util.hide(t)},showError:function(e,i,s){t=r.loading(),n=r.error();var o;e.status===404?o=e.responseText:o=e.statusText,o.indexOf("Error: ENOENT, ")?o.indexOf("Error: EACCES,")||(o=o.replace("Error: EACCES, p","P")):o=o.replace("Error: ENOENT, n","N"),Util.show(n),n.title=o;var u=t.parentElement;u&&u.appendChild(n),Util.hide(t),console.log(o)}},this.getCurrentFile=function(){var e=i.getByClass(CloudCommander.CURRENT_FILE)[0];return e||this.addCloudStatus({code:-1,msg:"Error: can not find CurrentFile in getCurrentFile"}),e},this.getRefreshButton=function(){var e=this.getPanel(),t=this.getByClass(CloudFunc.REFRESHICON,e);return t.length?t=t[0]:(this.addCloudStatus({code:-3,msg:"Error Refresh icon not found"}),t=!1),t},this.setCurrentFile=function(e){var t=!0;e||(this.addCloudStatus({code:-1,msg:"Error pCurrentFile insetCurrentFilecould not be none"}),t=!1);var n=this.getCurrentFile();e.className==="path"&&(e=e.nextSibling),e.className==="fm_header"&&(e=e.nextSibling),n&&s(n);var r=CloudCommander.CURRENT_FILE;return this.addClass(e,r),Util.scrollIntoViewIfNeeded(e),t};var s=function(e){e||Util.addCloudStatus({code:-1,msg:"Error pCurrentFile inunSetCurrentFilecould not be none"});var t=Util.isCurrentFile(e),n=CloudCommander.CURRENT_FILE;return t&&Util.removeClass(e,n),t};this.isCurrentFile=function(e){e||this.addCloudStatus({code:-1,msg:"Error pCurrentFile inisCurrentFilecould not be none"});var t=CloudCommander.CURRENT_FILE,n=e.className;return n.indexOf(t)>=0},this.getCurrentLink=function(e){var t;if(e)t=this.getByTag("a",e)[0];else{var n=this.getCurrentFile();t=this.getByTag("a",n)[0]}return t||this.addCloudStatus({code:-1,msg:"Error current element do not contain links"}),t},this.getCurrentName=function(e){var t=this.getCurrentFile(),n;return n=this.getCurrentLink(e?e:t),n?n=n.textContent:this.addCloudStatus({code:-1,msg:"Error current element do not contain links"}),n},this.getPanel=function(e){var t;t=i.getCurrentFile().parentElement;if(e&&!e.active){var n=t.id==="left"?"right":"left";t=i.getById(n)}return window.innerWidth<CloudCommander.MIN_ONE_PANEL_WIDTH&&(t=i.getById("left")),t||console.log("Error can not find Active Panel"),t},this.show=function(e){Util.removeClass(e,"hidden")},this.showPanel=function(e){var t=i.getPanel(e);t&&this.show(t)},this.hidePanel=function(e){var t=i.getPanel(e);t&&this.hide(t)},this.hide=function(e){return this.addClass(e,"hidden")},this.removeClass=function(e,t){e.classList?e.classList.remove(t):e.className.length>t.length&&(e.className=e.className.replace(t,""))},this.removeCurrent=function(e){var t=e.parentElement;e||(e=this.getCurrentFile());var n=this.getCurrentName(e);if(e&&t)if(n!==".."){var r=e.nextSibling,i=e.previousSibling;r?Util.setCurrentFile(r):i&&Util.setCurrentFile(i),t.removeChild(e)}else this.addCloudStatus({code:-1,msg:"Could not remove parrent dir"});else this.addCloudStatus({code:-1,msg:"Current file (or parent of current) could not be empty"});return e},this.scrollIntoViewIfNeeded=function(e){var t=!0;return e&&e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded():t=!1,t},this.CloudStatus=[],this.addCloudStatus=function(e){this.CloudStatus[this.CloudStatus.length]=e}},CloudClient.Util=new CloudClient.Util,CloudClient.KeyBinding=function(){Util.jsload(CloudClient.LIBDIRCLIENT+"keyBinding.js",function(){cloudcmd.KeyBinding.init(),KeyBinding=cloudcmd.KeyBinding})},CloudClient.Editor=function(e,t){Util.jsload(CloudClient.LIBDIRCLIENT+"editor/_codemirror.js",{onload:function(){cloudcmd.Editor.Keys(e,t)}})},CloudClient.Config=function(){Util.Images.showLoad({top:!0}),Util.jsload(CloudClient.LIBDIRCLIENT+"config.js",{onload:function(){cloudcmd.Config.Keys()}})},CloudClient.GoogleAnalytics=function(){var e=document.onmousemove;document.onmousemove=function(){setTimeout(function(){Util.jsload("lib/client/google_analytics.js")},5e3),typeof e=="function"&&e(),document.onmousemove=e}},CloudClient.Viewer=function(e){Util.jsload(CloudClient.LIBDIRCLIENT+"viewer.js",{onload:function(){cloudcmd.Viewer.Keys(e)}})},CloudClient.Terminal=function(){Util.jsload(CloudClient.LIBDIRCLIENT+"terminal.js",{onload:function(){cloudcmd.Terminal.Keys()}})},CloudClient.Menu=function(e){Util.jsload(CloudClient.LIBDIRCLIENT+"menu.js",{onload:function(){cloudcmd.Menu.Keys(e)}})},CloudClient._loadDir=function(e,t){return function(){Util.Images.showLoad(t?{top:!0}:null);var n=Util.getPanel(),r=Util.getByClass("path",n);r=r[0].textContent,r=CloudFunc.removeLastSlash(r);var i=r.substr(r,r.lastIndexOf("/"));r=r.replace(i+"/",""),CloudClient._ajaxLoad(e,t);var s=Util.getCurrentLink(this);return s&&s.textContent===".."&&r!=="/"&&CloudClient._currentToParent(r),!1}},CloudClient._editFileName=function(e){var t=Util.getCurrentLink(e);if(t&&t.textContent!==".."){t.contentEditable=!0,KeyBinding.unSet();var n=document.onclick;document.onclick=function(){var t=Util.getCurrentLink(e);t&&t.textContent!==".."&&(t.contentEditable=!1),KeyBinding.set(),document.onclick=n,typeof n=="function"&&n()}}},CloudClient._setCurrent=function(){return function(e){var t=Util.getCurrentFile();t&&(!Util.isCurrentFile(this)||typeof e=="boolean")&&Util.setCurrentFile(this);if(e===!0)if(typeof this.ondblclick=="function")this.ondblclick(this);else{var n=this.getElementsByTagName("a")[0];typeof n.ondblclick=="function"&&n.ondblclick(this)}else e.returnValue=!1;return!1}},CloudClient._currentToParent=function(e){var t=Util.getPanel();e=e.replace("/","");var n=getById(e+"("+t.id+")");n&&(Util.setCurrentFile(n),Util.scrollIntoViewIfNeeded(n,!0))},CloudClient.init=function(){Util=cloudcmd.Util,KeyBinding=cloudcmd.KeyBinding,getByClass=Util.getByClass,getById=Util.getById,document.body.scrollIntoViewIfNeeded?CloudClient.baseInit():(this.OLD_BROWSER=!0,Util.jsload(CloudClient.LIBDIRCLIENT+"ie.js",function(){Util.jqueryLoad(CloudClient.baseInit)}))},CloudClient.baseInit=function(){if(applicationCache){var e=applicationCache.onupdateready;applicationCache.onupdateready=function(){console.log("app cacheed"),location.reload(),typeof e=="function"&&e()}}var t=Util.getByTag("title");t.length>0&&(t[0].textContent="Cloud Commander"),Util.jsload(CloudClient.LIBDIR+"cloudfunc.js",function(){CloudFunc=window.CloudFunc,CloudClient._changeLinks(CloudFunc.LEFTPANEL),CloudClient._changeLinks(CloudFunc.RIGHTPANEL),CloudClient.Cache.isAllowed(),CloudClient.Cache.get("/")||CloudClient.Cache.set("/",CloudClient._getJSONfromFileTable())});var n=getByClass("fm_header");n&&n[0].nextSibling&&Util.setCurrentFile(n[0].nextSibling);var r=getById("fm");r&&(r.className="localstorage");var i=window.screen.height-(window.screen.height/3).toFixed();i=(i/100).toFixed()*100,CloudClient.HEIGHT=i,Util.cssSet({id:"cloudcmd",element:document.head,inner:".panel{height:"+i+"px;"+"}"})},CloudClient._changeLinks=function(e){var t=getById("clear-cache");t&&(t.onclick=CloudClient.Cache.clear);var n=getById(e),r=n.getElementsByTagName("a"),i=0,s=CloudFunc.NOJS,o=CloudFunc.FS,u=function(e){var t=!0;KeyBinding.unSet();var n=e.currentTarget||e.target;return Util.setCurrentFile(n),typeof CloudCommander.Menu=="function"&&(CloudCommander.Menu({x:e.x,y:e.y}),t=!1,Util.Images.showLoad()),t},a=function(e){var t=e.target,n=t.href,r=t.textContent,i=t.parentElement.nextSibling;i&&i.textContent==="<dir>"&&(n=n.replace(s,""),r+=".json"),e.dataTransfer.setData("DownloadURL","application/octet-stream:"+r+":"+n)},f=function(e){var t=e.target,n=t.tagName;if(n!=="LI")do t=t.parentElement,n=t.tagName;while(n!=="LI");Util.setCurrentFile(t)};for(var l=0;l<r.length;l++){var c="/"+r[l].href.replace(document.location.href,"");c.indexOf(s)===o.length&&(c=c.replace(s,""));if(l===i)r[l].onclick=CloudClient._loadDir(c,!0),r[l].parentElement.onclick=r[l].onclick;else{var h;try{h=r[l].parentElement.parentElement}catch(p){console.log(p)}h.className==="path"?r[l].onclick=CloudClient._loadDir(c):(h.onclick=CloudClient._setCurrent(),h.onmousedown=f,r[l].ondragstart=a,h.oncontextmenu=u,r[l].target!=="_blank"&&(h.ondblclick=CloudClient._loadDir(c),h.addEventListener&&h.addEventListener("touchend",CloudClient._loadDir(c),!1)),h.id=(r[l].title?r[l].title:r[l].textContent)+"("+e+")")}}},CloudClient._ajaxLoad=function(path,pNeedRefresh){var lPath=decodeURI(path),lFS_s=CloudFunc.FS;lPath.indexOf(lFS_s)===0&&(lPath=lPath.replace(lFS_s,""),lPath===""&&(lPath="/")),console.log('reading dir: "'+lPath+'";');var lPanel;try{lPanel=Util.getPanel().id}catch(error){console.log("Current panel not found\n"+error)}if(pNeedRefresh===undefined&&lPanel){var lJSON=CloudClient.Cache.get(lPath);if(lJSON!==null){if(window&&!window.JSON)try{lJSON=eval("("+lJSON+")")}catch(err){console.log(err)}else lJSON=JSON.parse(lJSON);CloudClient._createFileTable(lPanel,lJSON),CloudClient._changeLinks(lPanel);return}}try{Util.ajax({url:path,error:Util.Images.showError,success:function(e,t,n){if(!n.responseText.indexOf("Error:"))return Util.showError(n);CloudClient._createFileTable(lPanel,e),CloudClient._changeLinks(lPanel);var r=JSON.stringify(e);console.log(r.length),r.length<5e4&&CloudClient.Cache.set(lPath,r)}})}catch(err){console.log(err)}},CloudClient._createFileTable=function(e,t){var n=getById(e),r=getByClass("path",n),i=r[0].textContent===t[0].path,s;i&&(s=Util.getCurrentFile());var o=n.childNodes.length;while(o--)n.removeChild(n.lastChild);n.innerHTML=CloudFunc.buildFromJSON(t,!0);if(i&&s){for(o=0;o<n.childNodes.length;o++)if(n.childNodes[o].textContent===s.textContent){s=n.childNodes[o];break}Util.setCurrentFile(s)}},CloudClient._getJSONfromFileTable=function(){var e=getById("left"),t=getByClass("path")[0].textContent,n=[{path:t,size:"dir"}],r=e.getElementsByTagName("li"),i=1,s=1;s=2;for(;s<r.length;s++){var o=r[s].children,u={};for(var a=0;a<o.length;a++)u[o[a].className]=o[a];var f=u["mini-icon directory"]?!0:!1,l=u.name;l&&(l=l.getElementsByTagName("a")),l.length&&(l=l[0]),l.title&&(l=l.title)||(l=l.textContent);var c=f?"dir":u.size.textContent,h=u.mode.textContent;h=CloudFunc.convertPermissionsToNumberic(h),n[i++]={name:l,size:c,mode:h}}return JSON.stringify(n)},CloudClient}();try{window.onload=function(){"use strict";CloudCommander.init(),CloudCommander.KeyBinding(),CloudCommander.GoogleAnalytics()}}catch(err){}